<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Browse items â€” Marketplace</title>
    <link href="/css/styles.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Items for sale</h3>
        <div>
          <a class="btn btn" href="/sell.html">Sell</a>
          <a class="btn btn-primary ms-2" href="/profile.html">Profile</a>
        </div>
      </div>

      <div class="card">
        <div class="mb-2 d-flex">
          <input id="q" class="form-control me-2" placeholder="Search items" />
          <button id="searchBtn" class="btn btn-primary">Search</button>
        </div>

        <div id="grid" class="grid"></div>
      </div>
    </div>

    <script>
      async function load(q){
        const url = '/api/items' + (q?('?q='+encodeURIComponent(q)): '');
        const res = await fetch(url);
        const items = await res.json();
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        if(items.length === 0) grid.innerHTML = '<p class="muted">No items found</p>';
        items.forEach(it =>{
          const el = document.createElement('div'); el.className='card';
          const img = it.image ? `<img src="${it.image}" class="item-img">` : '';
          el.innerHTML = `${img}<h5>${it.title}</h5><p class="muted">$${it.price.toFixed(2)}</p><p>${it.description||''}</p><div><button class="btn btn-primary" data-id="${it.id}">Buy / Contact</button></div>`;
          grid.appendChild(el);
        });
        document.querySelectorAll('button[data-id]').forEach(btn=>{
          btn.addEventListener('click', async (e)=>{
            const id = e.target.dataset.id;
            const token = localStorage.getItem('token');
            if(!token){ if(confirm('Please log in to contact the seller. Go to login?')) window.location.href='/public/login.html'; return }
            const res = await fetch('/api/items/'+id+'/buy', { method:'POST', headers:{ 'Authorization':'Bearer '+token } });
            const json = await res.json();
            if(res.ok){ alert('Seller contact: ' + json.seller.email); load(); } else alert(json.message || 'Error');
          })
        })
      }

      document.getElementById('searchBtn').addEventListener('click', ()=> load(document.getElementById('q').value));
      load();
    </script>
  </body>
</html>
